<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style>
h2 {
}

ul {
	margin: 0;
}

.centerMe {
}

.button:hover {

}

#myId:hover {

}

#upperSpheres {
	background-color: LightGrey;
}
#middleSpheres {
	background-color: DarkGrey;
}
#lowerSpheres {
	background-color: Grey;
}

.col {
	background-color: White;
	position: absolute;
	transform: translate(-50%);
	width: 70px;
	height: 70px;
}

.textContainer {
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%,-50%);
}

.col1 {
	left: 16.66%;
}

.col2 {
	left: 33.33%;
}

.col3 {
	left: 50.00%;
}

.col4 {
	left: 66.66%;
}

.col5 {
	left: 83.33%;
}

.sphereRow {
	position: relative;
	height: 40px;
	width: 500px;
	margin: 10px;
}

.sphereSection {
	display: table;
}

#spheresContainer {
	position: absolute;
	left: 50%;
	transform: translate(-50%);
}

area {
	cursor: pointer;
}

span {
	vertical-align: top;
}

#mapInfoContainer {
	display: inline-block;
	vertical-align: top;
	max-width: 400px;
}

#sphereImage {
	display: inline-block;
}

#reinforcementList {
	display: inline-block;
	vertical-align: top;
}

#pop {
	float:right;
}

</style>
<script>
//Sphere size in pixels
var sphereSize = 25;
var imageWidth = 333;
var imageHeight = 792;

var spheres = [
	["Ah",			{x: 168, y: 45, links: [
										"Zon",
										"Xi",
										"Nehn"]}],
	["Zon",			{x: 105, y: 100, links: [
										"Ah",
										"Xi",
										"Nehn",
										"Hel"]}],
	["Xi",			{x: 230, y: 100, links: [
										"Ah",
										"Zon",
										"Nehn",
										"Sige"]}],
	["Nehn",		{x: 168, y: 160, links: [
										"Ah",
										"Zon",
										"Xi",
										"Hel",
										"Sige",
										"Es"]}],
	["Hel",			{x: 105, y: 223, links: [
										"Zon",
										"Nehn",
										"Sige",
										"Es"]}],
	["Sige",		{x: 230, y: 223, links: [
										"Xi",
										"Nehn",
										"Hel",
										"Es"]}],
	["Es",			{x: 168, y: 285, links: [
										"Nehn",
										"Hel",
										"Sige",
										"Telazch",
										"Yengenze",
										"Akhmah"]}],
	["Telazch",		{x: 105, y: 340, links: [
										"Es",
										"Yengenze",
										"Akhmah",
										"Tzimtzvot",
										"Noth"]}],
	["Yengenze",	{x: 230, y: 340, links: [
										"Es",
										"Telazch",
										"Akhmah",
										"Balarim",
										"Konis"]}],
	["Tzimtzvot",	{x: 35, y: 340, links: [
										"Telazch",
										"Akhmah",
										"Noth"]}],
	["Akhmah",		{x: 168, y: 340, links: [
										"Es",
										"Telazch",
										"Yengenze",
										"Tzimtzvot",
										"Balarim",
										"Noth",
										"Konis",
										"Jal"]}],
	["Balarim",		{x: 296, y: 340, links: [
										"Yengenze",
										"Akhmah",
										"Konis"]}],
	["Noth",		{x: 105, y: 457, links: [
										"Telazch",
										"Tzimtzvot",
										"Akhmah",
										"Konis",
										"Jal"]}],
	["Konis",		{x: 230, y: 457, links: [
										"Yengenze",
										"Akhmah",
										"Balarim",
										"Noth",
										"Jal"]}],
	["Jal",			{x: 168, y: 514, links: [
										"Akhmah",
										"Noth",
										"Konis",
										"Gesh",
										"Hal",
										"Undyne"]}],
	["Gesh",		{x: 105, y: 574, links: [
										"Jal",
										"Hal",
										"Undyne",
										"Non"]}],
	["Hal",			{x: 230, y: 574, links: [
										"Jal",
										"Gesh",
										"Undyne",
										"Neth"]}],
	["Undyne",		{x: 168, y: 636, links: [
										"Jal",
										"Gesh",
										"Hal",
										"Non",
										"Neth",
										"En"]}],
	["Non",			{x: 105, y: 700, links: [
										"Gesh",
										"Undyne", 
										"Neth", 
										"En"]}],
	["Neth",		{x: 230, y: 700, links: [
										"Hal",
										"Undyne",
										"Non",
										"En"]}],
	["En",			{x: 168, y: 756, links: [
										"Non",
										"Neth",
										"Undyne"]}]
];
var sphereMap = new Map(spheres);

var selectedPath = ["Akhmah"];

/* Reinitialize everything */
function reset() {
	selectedPath = ["Akhmah"];
	updatePage();
}

function getParameterByName(name, url) {
    if (!url) url = window.location.href;
	console.log("getParameterByName [name="+name+", url="+url+"]");
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

/* Update the page with the current state */
function updatePage() {
	//Set share string
	console.log("updatePage [selectedPath=[" + selectedPath.toString() + "]]");
	var currUrl = window.location.href.substring(0, window.location.href.length-window.location.search.length);
	console.log("currUrl="+currUrl);
	var currPathChoices = selectedPath.slice(1, selectedPath.length);
	var currPathString = currPathChoices.toString();
	console.log("currPathChoices=["+currPathString+"]");
	var nerveStatValue = Number(document.getElementById("nerveStat").value);
	var shareString = currUrl+"?path="+currPathString+"&nerve="+nerveStatValue;
	if(document.getElementById("advantageState").checked) {
		shareString = shareString + "&state=adv";
	} else if (document.getElementById("disadvantageState").checked) {
		shareString = shareString + "&state=dis";
	}
	var shareStringElem = document.getElementById("shareString");
	shareStringElem.innerHTML=shareString;
	shareStringElem.href=shareString;
	
	//Set current path and reinforcements
	var currPathString = "";
	var prevSphere = "";
	var reinforcements = 0;
	var reinforcementListElem = document.getElementById("reinforcementList");
	reinforcementListElem.innerHTML=""; //Clear reinforcement list
	var updateSphereReinforcement = function() {
		if(currPathString.length > 1) {
			currPathString = currPathString + ", ";
		}
		currPathString = currPathString + prevSphere;
		if(reinforcements > 0) {
			currPathString = currPathString + " + " + reinforcements;
			
			//Add element to reinforcementList
			var li = document.createElement("li");
			li.innerHTML=prevSphere+": "+reinforcements;
			reinforcementListElem.appendChild(li);
		}
		
		//Reset for the next sphere
		prevSphere = currSphere;
		reinforcements = 0;
	};
	for(var pathIndex = 0; pathIndex < selectedPath.length; pathIndex++) {
		var currSphere = selectedPath[pathIndex];
		
		//If this is a reinforcement, add to the reinforcement count
		if(prevSphere === currSphere) {
			reinforcements++;
		} 
		//Else, add the previous sphere and reset for the next sphere
		else {
			updateSphereReinforcement();
		}
	}
	updateSphereReinforcement(); //We need a final update to clear the currently held value
	document.getElementById("currentPathString").innerHTML = currPathString;
	
	//Set nerve rolls
	document.getElementById("nerveRollsString").innerHTML = selectedPath.length + " (" + (selectedPath.length - 1) + " + 1)";
	
	var advantageValue = 0; //1 for advantage, -1 for disadvantage
	if(document.getElementById("advantageState").checked) {
		advantageValue = 1;
	} else if (document.getElementById("disadvantageState").checked) {
		advantageValue = -1;
	}
	console.log("computing odds of success [nerveStatValue="+nerveStatValue+", advantageValue="+advantageValue+", rolls="+selectedPath.length+"]");
	var insanityCalculationValue = computeInsanityChances(nerveStatValue,advantageValue,selectedPath.length);
	document.getElementById("insanitySuccessOdds").innerHTML = insanityCalculationValue.insanitySuccessOdds*100 + "%";
	document.getElementById("avgNervePenalty").innerHTML = insanityCalculationValue.averageNervePenalty;
	//TODO set calculation tables
	
	//TODO redraw path
}

function computeInsanityChances(nerveStatValue, advantageValue, pathLeft) {
	var successOdds = nerveStatValue;
	//A 1 is considered an automatic success regardless of penalties, so there's always at least 1/20 chance of success
	if(successOdds < 2) {
		successOdds = 1;
	} 
	//A 20 is considered an automatic failure regardless of penaltiesm so there's always at most 19/20 chances of success
	else if(successOdds > 19) {
		successOdds = 19;
	}
	/* Else, remove one from the stat to get the chances of success. 
	 * This is roll under, which means that if we have
	 * a nerve stat of 3 we can only succeed on a roll of 1 or 2 -> 2/20
	 */
	else {
		successOdds = successOdds - 1;
	}
	var failOdds = 20 - successOdds;
	
	//Recursion stop condition: reached the end of the path, so just return the odds of the final roll
	if(pathLeft === 1) {
		//The final roll doesn't get a reroll, so no need to take advantage/disadvantage into account
		return {insanitySuccessOdds: successOdds/20, 
				//No nerve penalty for the final roll. The effects of failing it should be penalty enough
				averageNervePenalty: 0}
	}
	
	var totalOdds = 20;
	if(advantageValue>0) { //At advantage
		//At advantage, we have all the times we succeed in the first roll + all the times we fail in the first but succeed in the second roll. 
		//The *20 is to simulate that we don't care what happens with the second roll in case the first succeeds
		successOdds = successOdds*20 + failOdds*successOdds;
		failOdds = failOdds*failOdds;
		totalOdds = 400; //20*20
	} else if(advantageValue<0) { //At disadvantage
		failOdds = failOdds*20 + successOdds*failOdds;
		successOdds = successOdds*successOdds;
		totalOdds = 400; //20*20
	}
	var insanitySuccessCalculation = computeInsanityChances(nerveStatValue, advantageValue, pathLeft - 1);
	var insanityFailureCalculation = computeInsanityChances(nerveStatValue-1, advantageValue, pathLeft - 1);
	var insanitySuccessOdds = (successOdds * insanitySuccessCalculation.insanitySuccessOdds
			+ failOdds * insanityFailureCalculation.insanitySuccessOdds)/totalOdds;
	var averageNervePenalty = (failOdds/totalOdds) + 
			((successOdds * insanitySuccessCalculation.averageNervePenalty
			+ failOdds * insanityFailureCalculation.averageNervePenalty)/totalOdds);
	return {insanitySuccessOdds: insanitySuccessOdds, 
			averageNervePenalty: averageNervePenalty};
}

/* Do any initial drawing necessary, create the map and load a path if necessary */
function drawValidateAndLoad() {
	//Create the onClicks for the image
	var map = document.getElementById("sphereMap");
	for(var sphereIndex = 0; sphereIndex < spheres.length; sphereIndex++) {
		var sphereName = spheres[sphereIndex][0]
		console.log("Adding "+sphereName);
		var currSphere = spheres[sphereIndex][1];
		var currArea = document.createElement("area");
		currArea.id=sphereName;
		currArea.shape="circle";
		currArea.coords=currSphere.x+","+currSphere.y+","+sphereSize;
		currArea.alt=sphereName;
		currArea.href="javascript:void(0);";
		currArea.onclick=function() {
			addSphereToPath(this.id);
			return false;
		};
		map.appendChild(currArea);
	}
	
	var loadString = getParameterByName("path");
	console.log("Loading path [loadString="+loadString+"]");
	if(loadString != null && loadString.length > 1) {
		var splitLoadString = loadString.split(",");
		console.log("Loading split path [splitLoadString.length="+splitLoadString.length+", splitLoadString=["+splitLoadString+"]]");
		for(var loadIndex=0; loadIndex < splitLoadString.length; loadIndex++) {
			var toLoad = splitLoadString[loadIndex];
			console.log("Loading [toLoad="+toLoad+"]");
			if(!(addSphereToPath(toLoad) === true)) {
				alert("Load failed!\nOnly "+loadIndex+" out of "+splitLoadString.length+" steps loaded.")
				break;
			}
		}
	}
	
	//Load the nerve value
	var loadNerveValue = getParameterByName("nerve");
	console.log("loadNerveValue="+loadNerveValue);
	if(loadNerveValue != null) {
		loadNerveValue = Number(loadNerveValue);
		loadNerveValue = Math.floor(loadNerveValue);
		console.log("finalLoadNerveValue="+loadNerveValue);
		document.getElementById("nerveStat").value = loadNerveValue;
	} else {
		document.getElementById("nerveStat").value = 10;
	}
	
	//Load the state value
	var loadStateValue = getParameterByName("state");
	console.log("loadStateValue="+loadStateValue);
	if(loadStateValue != null) {
		if(loadStateValue === "adv") {
			console.log("state advantage");
			document.getElementById("advantageState").checked = true;
		} else if (loadStateValue === "dis") {
			console.log("state disadvantage");
			document.getElementById("disadvantageState").checked = true;
		} else {
			console.log("ignoring state");
		}
	}
	
	updatePage();
}

//Attempt to add a sphere to the path. Return true for success, false for failure
function addSphereToPath(selectedSphereName) {
	console.log("addSphereToPath [selectedSphereName="+selectedSphereName+"]");
	var currSphereName = selectedPath[selectedPath.length - 1];
	console.log("currSphereName="+currSphereName);
	
	//If we are reinforcing a sphere, simply add it to the path
	if(selectedSphereName === currSphereName) {
		selectedPath.push(selectedSphereName)
		
		updatePage();
		return true;
	}
	
	//If we are adding a new sphere and there is a link from the current sphere to the new one, simply add it to the path
	var currSphere = sphereMap.get(currSphereName);
	if(currSphere.links.includes(selectedSphereName)) { 
		selectedPath.push(selectedSphereName)
		
		updatePage();
		return true;
	}
	
	//Else, display error
	alert("Invalid selection!\n"+
			"You can't go from "+currSphereName+" to "+selectedSphereName+".\n\n"+
			"Possible choices: "+currSphere.links.toString());
	return false;
}

function popLastSphere() {
	console.log("Pop last sphere");
	if(selectedPath.length <= 1) {
		console.log("Already at the begining, nothing to pop");
		return;
	}
	console.log("Popped: " + selectedPath.pop());
	updatePage();
}

</script>
</head>
<body onload="drawValidateAndLoad()">
	<noscript>This page requires JavaScript to work properly</noscript>
	<div>
		<img id="sphereImage" src="https://i.imgur.com/QRDCKzF.png" alt="Spheres" usemap="#sphereMap">

		<map id="sphereMap" name="sphereMap">
		</map>
		
		<form id="mapInfoContainer">
			<div><b>Current Path:</b> <span id="currentPathString"></span> <input id="pop" name="pop" type="button" value="Remove Last Sphere" onclick="popLastSphere()"/> </div>
			<div><b>Nerve Rolls:</b> <span id="nerveRollsString"></span></div>
			<div><b>Nerve Stat:</b> <input id="nerveStat" name="nerveStat" type="number" step="1" required="true" oninput="updatePage()" /></div>
			<div><b>State:</b> 
				<input id="advantageState" name="state" type="radio" required="true" oninput="updatePage()">Advantage</input>
				<input id="normalState" name="state" type="radio" required="true" oninput="updatePage()" checked>Normal</input>
				<input id="disadvantageState" name="state" type="radio" required="true" oninput="updatePage()">Disadvantage</input>
			</div>
			<div><b>Insanity Roll Success Odds:</b> <span id="insanitySuccessOdds"></span></div>
			<div><b>Average Nerve Penalty:</b> <span id="avgNervePenalty"></span></div>
			<div><b>Reinforcements:</b> <ul id="reinforcementList"></ul></div>
		</form>
		<div><b>Share Link:</b> <a id="shareString" target="_blank" href=""></a></div>
	</div>
</body>
